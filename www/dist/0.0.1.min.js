function run($rootScope,$state){$rootScope.$on("$stateChangeError",function(event,toState,toParams,fromState,fromParams,error){"AUTH_REQUIRED"===error&&$state.go("login")})}function run($ionicPlatform){$ionicPlatform.ready(function(){window.cordova&&window.cordova.plugins&&window.cordova.plugins.Keyboard&&(cordova.plugins.Keyboard.hideKeyboardAccessoryBar(!0),cordova.plugins.Keyboard.disableScroll(!0)),window.StatusBar&&StatusBar.styleLightContent()})}function config($stateProvider,$urlRouterProvider){$stateProvider.state("tab",{url:"/tab","abstract":!0,templateUrl:"js/templates/tabs.html",resolve:{user:["$meteor",function($meteor){return $meteor.requireUser()}],chats:["$meteor",function($meteor){return $meteor.subscribe("chats")}]}}),$urlRouterProvider.otherwise("/tab/chats")}function input($timeout){function link(scope,element,attrs){element.bind("focus",function(e){scope.onFocus&&$timeout(function(){scope.onFocus()})}),element.bind("blur",function(e){scope.onBlur&&$timeout(function(){scope.onBlur()})}),element.bind("keydown",function(e){13==e.which&&(scope.returnClose&&element[0].blur(),scope.onReturn&&$timeout(function(){scope.onReturn()}))})}var directive={restrict:"E",scope:{returnClose:"=",onReturn:"&",onFocus:"&",onBlur:"&"},link:link};return directive}function calendar(){return function(time){return time?moment(time).calendar(null,{lastDay:"[Yesterday]",sameDay:"LT",lastWeek:"dddd",sameElse:"DD/MM/YY"}):void 0}}function chatName(){return function(chat){if(chat){var otherId=_.without(chat.userIds,Meteor.userId())[0],otherUser=Meteor.users.findOne(otherId),hasName=otherUser&&otherUser.profile&&otherUser.profile.name;return hasName?otherUser.profile.name:"PLACE HOLDER"}}}function chatPicture(){return function(chat){if(chat){var otherId=_.without(chat.userIds,Meteor.userId())[0],otherUser=Meteor.users.findOne(otherId),hasPicture=otherUser&&otherUser.profile&&otherUser.profile.picture;return hasPicture?otherUser.profile.picture:"/img/user-default.svg"}}}function ChatDetailConfig($stateProvider){$stateProvider.state("tab.chat-detail",{url:"/chats/:chatId",views:{"tab-chats":{templateUrl:"js/controllers/chat/chat-detail.html",controller:"ChatDetailCtrl"}}})}function ChatDetailCtrl($scope,$stateParams,$timeout,$meteor,$ionicScrollDelegate){function sendMessage(){_.isEmpty($scope.data.message)||($meteor.call("newMessage",{text:$scope.data.message,chatId:chatId}),delete $scope.data.message)}function inputUp(){isIOS&&($scope.data.keyboardHeight=216),$timeout(function(){$ionicScrollDelegate.$getByHandle("chatScroll").scrollBottom(!0)},300)}function inputDown(){isIOS&&($scope.data.keyboardHeight=0),$ionicScrollDelegate.$getByHandle("chatScroll").resize()}function closeKeyboard(){}var chatId=$stateParams.chatId,isIOS=ionic.Platform.isWebView()&&ionic.Platform.isIOS();$scope.chat=$scope.$meteorObject(Chats,chatId,!1),$scope.messages=$scope.$meteorCollection(function(){return Messages.find({chatId:chatId})},!1),$scope.data={},$scope.$watchCollection("messages",function(oldVal,newVal){var animate=oldVal.length!==newVal.length;$ionicScrollDelegate.$getByHandle("chatScroll").scrollBottom(animate)}),$scope.sendMessage=sendMessage,$scope.inputUp=inputUp,$scope.inputDown=inputDown,$scope.closeKeyboard=closeKeyboard}function ChatsConfig($stateProvider){$stateProvider.state("tab.chats",{url:"/chats",views:{"tab-chats":{templateUrl:"js/controllers/chat/tab-chats.html",controller:"ChatsCtrl"}}})}function ChatsCtrl($scope,$meteor,$ionicModal){function openNewChatModal(){$scope.modal.show()}function remove(chat){$meteor.call("removeChat",chat._id)}$scope.chats=$scope.$meteorCollection(Chats,!1),$ionicModal.fromTemplateUrl("js/controllers/chat/new-chat.html",{scope:$scope}).then(function(modal){$scope.modal=modal}),$scope.$on("$destroy",function(){$scope.modal.remove()}),$scope.openNewChatModal=openNewChatModal,$scope.remove=remove}function NewChatCtrl($scope,$state,$meteor){function hideModal(){$scope.modal.hide()}function newChat(userId){var chat=Chats.findOne({type:"chat",userIds:{$all:[Meteor.userId(),userId]}});return chat?goToChat(chat._id):void $meteor.call("newChat",userId).then(goToChat)}function goToChat(chatId){return hideModal(),$state.go("tab.chat-detail",{chatId:chatId})}$scope.$meteorSubscribe("users").then(function(){$scope.users=$scope.$meteorCollection(function(){return Meteor.users.find({_id:{$ne:Meteor.userId()}})},!1)}),$scope.hideModal=hideModal,$scope.newChat=newChat}function ConfirmationConfig($stateProvider){$stateProvider.state("confirmation",{url:"/confirmation/:phone",templateUrl:"js/controllers/login/confirmation.html",controller:"ConfirmationCtrl"})}function ConfirmationCtrl($scope,$state,$ionicPopup,$log){function verify(){_.isEmpty($scope.data.code)||Accounts.verifyPhone($scope.phone,$scope.data.code,function(err){return err?handleError(err):void $state.go("profile")})}function handleError(err){$log.error("Verfication error ",err),$ionicPopup.alert({title:err.reason||"Verfication failed",template:"Please try again",okType:"button-positive button-clear"})}$scope.phone=$state.params.phone,$scope.data={},$scope.verify=verify}function LoginConfig($stateProvider){$stateProvider.state("login",{url:"/login",templateUrl:"js/controllers/login/login.html",controller:"LoginCtrl"})}function LoginCtrl($scope,$state,$ionicLoading,$ionicPopup,$log){function login(){if(!_.isEmpty($scope.data.phone)){var confirmPopup=$ionicPopup.confirm({title:"Number confirmation",template:"<div>"+$scope.data.phone+"</div><div>Is your phone number above correct?</div>",cssClass:"text-center",okText:"Yes",okType:"button-positive button-clear",cancelText:"edit",cancelType:"button-dark button-clear"});confirmPopup.then(function(res){res&&($ionicLoading.show({template:"Sending verification code..."}),Accounts.requestPhoneVerification($scope.data.phone,function(err){return $ionicLoading.hide(),err?handleError(err):void $state.go("confirmation",{phone:$scope.data.phone})}))})}}function handleError(err){$log.error("Login error ",err),$ionicPopup.alert({title:err.reason||"Login failed",template:"Please try again",okType:"button-positive button-clear"})}$scope.data={},$scope.login=login}function ProfileConfig($stateProvider){$stateProvider.state("profile",{url:"/profile",templateUrl:"js/controllers/setting/profile.html",controller:"ProfileCtrl",resolve:{user:["$meteor",function($meteor){return $meteor.requireUser()}]}})}function ProfileCtrl($scope,$state,$meteor,$ionicLoading,$ionicPopup,$log){function updateName(){_.isEmpty($scope.data.name)||$meteor.call("updateName",$scope.data.name).then(function(){$state.go("tab.chats")})["catch"](handleError)}function handleError(err){$log.error("profile save error ",err),$ionicPopup.alert({title:err.reason||"Save failed",template:"Please try again",okType:"button-positive button-clear"})}var user=Meteor.user(),name=user&&user.profile?user.profile.name:"";$scope.data={name:name},$scope.updateName=updateName}function SettingsConfig($stateProvider){$stateProvider.state("tab.settings",{url:"/settings",views:{"tab-settings":{templateUrl:"js/controllers/setting/tab-settings.html",controller:"SettingsCtrl"}}})}function SettingsCtrl($scope,$meteor,$state){function logout(){$meteor.logout().then(function(){$state.go("login")})}$scope.logout=logout}!function(module){try{module=angular.module("chattyTemplates")}catch(e){module=angular.module("chattyTemplates",[])}module.run(["$templateCache",function($templateCache){$templateCache.put("js/templates/tabs.html",'<ion-tabs class="tabs-stable tabs-icon-top tabs-color-positive" ng-cloak>\n\n  <ion-tab title="Favorites" icon-off="ion-ios-star-outline" icon-on="ion-ios-star" href="#/tab/favorites">\n    <ion-nav-view name="tab-favorites"></ion-nav-view>\n  </ion-tab>\n\n  <ion-tab title="Recents" icon-off="ion-ios-clock-outline" icon-on="ion-ios-clock" href="#/tab/recents">\n    <ion-nav-view name="tab-recents"></ion-nav-view>\n  </ion-tab>\n\n  <ion-tab title="Contacts" icon-off="ion-ios-person-outline" icon-on="ion-ios-person" href="#/tab/contacts">\n    <ion-nav-view name="tab-contacts"></ion-nav-view>\n  </ion-tab>\n\n  <ion-tab title="Chats" icon-off="ion-ios-chatboxes-outline" icon-on="ion-ios-chatboxes" href="#/tab/chats">\n    <ion-nav-view name="tab-chats"></ion-nav-view>\n  </ion-tab>\n\n  <ion-tab title="Settings" icon-off="ion-ios-cog-outline" icon-on="ion-ios-cog" href="#/tab/settings">\n    <ion-nav-view name="tab-settings"></ion-nav-view>\n  </ion-tab>\n\n</ion-tabs>\n')}])}(),function(module){try{module=angular.module("chattyTemplates")}catch(e){module=angular.module("chattyTemplates",[])}module.run(["$templateCache",function($templateCache){$templateCache.put("js/controllers/chat/chat-detail.html",'<ion-view title="{{chat | chatName}}">\n  <ion-nav-buttons side="right">\n    <button class="button button-clear"><img class="header-picture" ng-src="{{chat | chatPicture}}"></button>\n  </ion-nav-buttons>\n\n  <ion-content class="chat" delegate-handle="chatScroll">\n    <div class="message-list">\n      <div ng-repeat="message in messages" class="message-wrapper">\n       <div class="message" ng-class="message.userId === $root.currentUser._id ? \'message-mine\' : \'message-other\'">\n          <div class="message-text">{{message.text}}</div>\n          <span class="message-timestamp">{{message.timestamp | amDateFormat: \'HH:MM\'}}</span>\n        </div>\n      </div>\n    </div>\n  </ion-content>\n\n  <ion-footer-bar keyboard-attach class="bar-stable footer-chat item-input-inset">\n    <button class="button button-clear button-icon button-positive icon ion-ios-upload-outline"></button>\n\n    <label class="item-input-wrapper">\n      <input\n        ng-model="data.message"\n        on-return="sendMessage(); closeKeyboard()"\n        on-focus="inputUp()"\n        on-blur="inputDown()"\n        dir="auto"\n        type="text"/>\n    </label>\n\n    <span ng-if="data.message.length > 0">\n      <button ng-click="sendMessage()" class="button button-clear button-positive">Send</button>\n    </span>\n    <span ng-if="!data.message || data.message.length === 0">\n      <button class="button button-clear button-icon button-positive icon ion-ios-camera-outline"></button>\n      <i class="buttons-seperator icon ion-android-more-vertical"></i>\n      <button class="button button-clear button-icon button-positive icon ion-ios-mic-outline"></button>\n    </span>\n  </ion-footer-bar>\n</ion-view>\n')}])}(),function(module){try{module=angular.module("chattyTemplates")}catch(e){module=angular.module("chattyTemplates",[])}module.run(["$templateCache",function($templateCache){$templateCache.put("js/controllers/chat/new-chat.html",'<ion-modal-view ng-controller="NewChatCtrl">\n  <ion-header-bar>\n    <h1 class="title">New Chat</h1>\n    <div class="buttons">\n      <button class="button button-clear button-positive" ng-click="hideModal()">Cancel</button>\n    </div>\n  </ion-header-bar>\n\n  <ion-content>\n    <div class="list">\n      <a ng-repeat="user in users" ng-click="newChat(user._id)" class="item">\n        <h2>{{user.profile.name}}</h2>\n        <p>\n          Hey there! I am using ionic-Whatsapp with meteor.\n        </p>\n      </a>\n    </div>\n  </ion-content>\n</ion-modal-view>\n')}])}(),function(module){try{module=angular.module("chattyTemplates")}catch(e){module=angular.module("chattyTemplates",[])}module.run(["$templateCache",function($templateCache){$templateCache.put("js/controllers/chat/tab-chats.html",'<ion-view view-title="Chats">\n  <ion-nav-buttons side="right">\n    <button ng-click="openNewChatModal()" class="button button-clear button-positive button-icon ion-ios-compose-outline"></button>\n  </ion-nav-buttons>\n\n  <ion-content>\n    <ion-list>\n      <ion-item\n        ng-repeat="chat in chats | orderBy:\'-lastMessage.timestamp\'"\n        class="item-chat item-remove-animate item-avatar item-icon-right"\n        type="item-text-wrap"\n        href="#/tab/chats/{{chat._id}}">\n        <img ng-src="{{chat | chatPicture}}">\n        <h2>{{chat | chatName}}</h2>\n        <p>{{chat.lastMessage.text}}</p>\n        <span class="last-message-timestamp">{{chat.lastMessage.timestamp | calendar}}</span>\n        <i class="icon ion-chevron-right icon-accessory"></i>\n\n        <ion-option-button class="button-assertive" ng-click="remove(chat)">\n          Delete\n        </ion-option-button>\n      </ion-item>\n    </ion-list>\n  </ion-content>\n</ion-view>\n')}])}(),function(module){try{module=angular.module("chattyTemplates")}catch(e){module=angular.module("chattyTemplates",[])}module.run(["$templateCache",function($templateCache){$templateCache.put("js/controllers/login/confirmation.html",'<ion-view title="{{phone}}">\n  <ion-nav-buttons side="right">\n    <button ng-click="verify()" ng-disabled="!data.code || data.code.length === 0" class="button button-clear button-positive">Done</button>\n  </ion-nav-buttons>\n\n  <ion-content>\n    <div class="text-center padding">\n      We have sent you an SMS with a code to the number above\n    </div>\n    <div class="text-center padding">\n      To complete your phone number verification chatty, please enter the 4-digit activation code.\n    </div>\n\n    <div class="list padding-top">\n      <label class="item item-input">\n        <input ng-model="data.code" on-return="verify()" type="text" placeholder="Code">\n      </label>\n    </div>\n  </ion-content>\n</ion-view>\n')}])}(),function(module){try{module=angular.module("chattyTemplates")}catch(e){module=angular.module("chattyTemplates",[])}module.run(["$templateCache",function($templateCache){$templateCache.put("js/controllers/login/login.html",'<ion-view title="Your phone number">\n  <ion-nav-buttons side="right">\n    <button ng-click="login()" ng-disabled="!data.phone || data.phone.length === 0" class="button button-clear button-positive">Done</button>\n  </ion-nav-buttons>\n\n  <ion-content class="login">\n    <div class="text-center instructions">\n      Please confirm your country code and enter your phone number\n    </div>\n\n    <div class="list">\n      <label class="item item-input">\n        <input ng-model="data.phone" on-return="login()" type="text" placeholder="Your phone number">\n      </label>\n    </div>\n  </ion-content>\n</ion-view>\n')}])}(),function(module){try{module=angular.module("chattyTemplates")}catch(e){module=angular.module("chattyTemplates",[])}module.run(["$templateCache",function($templateCache){$templateCache.put("js/controllers/setting/profile.html",'<ion-view title="Profile">\n  <ion-nav-buttons side="right">\n    <button ng-click="updateName()" ng-disabled="!data.name || data.name.length === 0" class="button button-clear button-positive">Done</button>\n  </ion-nav-buttons>\n\n  <ion-content class="profile">\n    <a class="profile-picture positive">\n      <div class="upload-placehoder">\n        Add photo\n      </div>\n    </a>\n\n    <div class="instructions">\n      Enter your name and add an optional profile picture\n    </div>\n\n    <div class="list profile-name">\n      <label class="item item-input">\n        <input ng-model="data.name" on-return="updateName()" type="text" placeholder="Your name">\n      </label>\n    </div>\n  </ion-content>\n</ion-view>\n')}])}(),function(module){try{module=angular.module("chattyTemplates")}catch(e){module=angular.module("chattyTemplates",[])}module.run(["$templateCache",function($templateCache){$templateCache.put("js/controllers/setting/tab-settings.html",'<ion-view view-title="Settings">\n  <ion-content>\n    <div class="padding text-center">\n      <button ng-click="logout()" class="button button-clear button-assertive">Logout</button>\n    </div>\n  </ion-content>\n</ion-view>\n')}])}(),angular.module("chatty",["ionic","angular-meteor","angularMoment","chattyTemplates"]),angular.module("chatty").run(run),Chats=new Mongo.Collection("chats"),Messages=new Mongo.Collection("messages"),angular.module("chatty").run(run),angular.module("chatty").config(config),Meteor.methods({newChat:function(otherId){check(otherId,String);var otherUser=Meteor.users.findOne(otherId);if(!otherUser)throw Meteor.Error("user-not-exists","Chat's user not exists");var chat={userIds:[this.userId,otherId],createdAt:new Date};return Chats.insert(chat)},removeChat:function(chatId){return check(chatId,String),Messages.remove({chatId:chatId}),Chats.remove({_id:chatId})},newMessage:function(message){check(message,{text:String,chatId:String}),message.timestamp=new Date,message.userId=this.userId;var messageId=Messages.insert(message);return Chats.update(message.chatId,{$set:{lastMessage:message}}),messageId}}),angular.module("chatty").directive("input",input),angular.module("chatty").filter("calendar",calendar),angular.module("chatty").filter("chatName",chatName),angular.module("chatty").filter("chatPicture",chatPicture),angular.module("chatty").config(ChatDetailConfig).controller("ChatDetailCtrl",ChatDetailCtrl),angular.module("chatty").config(ChatsConfig).controller("ChatsCtrl",ChatsCtrl),angular.module("chatty").controller("NewChatCtrl",NewChatCtrl),angular.module("chatty").config(ConfirmationConfig).controller("ConfirmationCtrl",ConfirmationCtrl),angular.module("chatty").config(LoginConfig).controller("LoginCtrl",LoginCtrl),angular.module("chatty").config(ProfileConfig).controller("ProfileCtrl",ProfileCtrl),angular.module("chatty").config(SettingsConfig).controller("SettingsCtrl",SettingsCtrl);